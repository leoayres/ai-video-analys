# ğŸ”¬ DocumentaÃ§Ã£o TÃ©cnica - Sistema de DetecÃ§Ã£o de Atividades

## VisÃ£o Geral

O sistema de detecÃ§Ã£o de atividades implementa uma abordagem multi-fatorial que combina anÃ¡lise de movimento, detecÃ§Ã£o de objetos e reconhecimento de padrÃµes para classificar aÃ§Ãµes humanas em categorias especÃ­ficas.

---

## Arquitetura do Sistema

### Fluxo de Processamento

```
Frame de VÃ­deo
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1. PrÃ©-processamento              â”‚
â”‚   - ConversÃ£o para escala de cinza  â”‚
â”‚   - DetecÃ§Ã£o de rostos              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   2. ExtraÃ§Ã£o de Features           â”‚
â”‚   - AnÃ¡lise de movimento regional   â”‚
â”‚   - DetecÃ§Ã£o de regiÃµes de pele     â”‚
â”‚   - DetecÃ§Ã£o de corpos superiores   â”‚
â”‚   - CÃ¡lculo de intensidade          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   3. AnÃ¡lise Contextual             â”‚
â”‚   - PosiÃ§Ã£o relativa mÃ£o-rosto      â”‚
â”‚   - DistribuiÃ§Ã£o espacial movimento â”‚
â”‚   - AnÃ¡lise temporal (histÃ³rico)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   4. ClassificaÃ§Ã£o de Atividade     â”‚
â”‚   - Usando Celular                  â”‚
â”‚   - Trabalhando (PC)                â”‚
â”‚   - Lendo / Estudando               â”‚
â”‚   - Conversando / Ocioso            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Componentes TÃ©cnicos

### 1. AnÃ¡lise de Movimento Regional

O frame Ã© dividido em trÃªs regiÃµes horizontais para anÃ¡lise independente:

```python
RegiÃ£o Superior (0-33%):    # CabeÃ§a, mÃ£os elevadas
RegiÃ£o MÃ©dia (33-66%):      # Tronco, teclado, mesa
RegiÃ£o Inferior (66-100%):  # Pernas, parte baixa
```

**Algoritmo:**
```python
def analyze_regional_movement(frame_atual, frame_anterior):
    # Divide frame em 3 regiÃµes
    superior = frame[0:h//3, :]
    media = frame[h//3:2*h//3, :]
    inferior = frame[2*h//3:, :]
    
    # Calcula diferenÃ§a absoluta para cada regiÃ£o
    diff_superior = cv2.absdiff(prev_superior, superior)
    diff_media = cv2.absdiff(prev_media, media)
    diff_inferior = cv2.absdiff(prev_inferior, inferior)
    
    # Aplica threshold
    _, thresh_sup = cv2.threshold(diff_superior, 25, 255, BINARY)
    _, thresh_med = cv2.threshold(diff_media, 25, 255, BINARY)
    _, thresh_inf = cv2.threshold(diff_inferior, 25, 255, BINARY)
    
    # Normaliza (0.0 a 1.0)
    motion_sup = sum(thresh_sup) / (pixels_sup * 255)
    motion_med = sum(thresh_med) / (pixels_med * 255)
    motion_inf = sum(thresh_inf) / (pixels_inf * 255)
    
    return {
        'superior': motion_sup,
        'media': motion_med,
        'inferior': motion_inf
    }
```

### 2. DetecÃ§Ã£o de RegiÃµes de Pele/MÃ£os

Utiliza espaÃ§o de cores HSV para identificar tons de pele:

```python
def detect_hand_regions(frame):
    # Converte BGR â†’ HSV
    hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
    
    # Range de cor de pele (calibrado)
    lower_skin = [0, 20, 70]    # H, S, V mÃ­nimos
    upper_skin = [20, 255, 255]  # H, S, V mÃ¡ximos
    
    # Cria mÃ¡scara binÃ¡ria
    skin_mask = cv2.inRange(hsv, lower_skin, upper_skin)
    
    # OperaÃ§Ãµes morfolÃ³gicas (remove ruÃ­do)
    kernel = np.ones((5,5), uint8)
    skin_mask = cv2.morphologyEx(skin_mask, MORPH_CLOSE, kernel)
    skin_mask = cv2.morphologyEx(skin_mask, MORPH_OPEN, kernel)
    
    # Encontra contornos
    contours = cv2.findContours(skin_mask, RETR_EXTERNAL, CHAIN_APPROX_SIMPLE)
    
    # Filtra por Ã¡rea (500 < Ã¡rea < 50000 pixels)
    hand_regions = []
    for contour in contours:
        area = cv2.contourArea(contour)
        if 500 < area < 50000:
            x, y, w, h = cv2.boundingRect(contour)
            hand_regions.append((x, y, w, h, area))
    
    return hand_regions
```

### 3. AnÃ¡lise de Proximidade MÃ£o-Rosto

Calcula distÃ¢ncia euclidiana entre centros de regiÃµes:

```python
def check_hand_near_face(faces, hands):
    for (fx, fy, fw, fh) in faces:
        face_center = (fx + fw//2, fy + fh//2)
        
        for (hx, hy, hw, hh, area) in hands:
            hand_center = (hx + hw//2, hy + hh//2)
            
            # DistÃ¢ncia euclidiana
            distance = sqrt((face_center[0] - hand_center[0])Â² + 
                          (face_center[1] - hand_center[1])Â²)
            
            # Threshold de proximidade: 150 pixels
            if distance < 150:
                return True
    
    return False
```

---

## Algoritmos de ClassificaÃ§Ã£o

### ğŸ”µ 1. Usando Celular

**CritÃ©rios de DetecÃ§Ã£o:**
- âœ… MÃ£o prÃ³xima ao rosto (< 150px)
- âœ… Movimento concentrado na regiÃ£o superior (> 0.03)
- âœ… Movimento Ã© localizado (nÃ£o distribuÃ­do)

```python
if hand_near_face AND upper_motion > 0.03 AND concentrated_motion:
    â†’ "Usando Celular"
```

**CaracterÃ­sticas Visuais:**
- BraÃ§o elevado
- MÃ£o na altura da face
- Movimento sutil mas constante
- Foco visual direcionado para baixo

---

### ğŸ’» 2. Trabalhando (PC)

**CritÃ©rios de DetecÃ§Ã£o:**
- âœ… Movimento predominante na regiÃ£o mÃ©dia
- âœ… Intensidade moderada (0.02 - 0.15)
- âœ… Face presente na cena
- âœ… PadrÃ£o consistente ao longo do tempo

```python
if middle_motion > upper_motion AND 
   middle_motion > 0.02 AND 
   motion_intensity < 0.15 AND 
   face_detected:
    
    # ConfirmaÃ§Ã£o com histÃ³rico (Ãºltimos 10 frames)
    if mean(last_10_middle_motions) > 0.02:
        â†’ "Trabalhando (PC)"
```

**CaracterÃ­sticas Visuais:**
- Movimento de mÃ£os na altura do teclado/mouse
- Postura frontal
- Movimento rÃ­tmico e consistente
- Baixa variabilidade temporal

---

### ğŸ“– 3. Lendo / Estudando

**CritÃ©rios de DetecÃ§Ã£o:**
- âœ… Face presente
- âœ… Movimento muito baixo (< 0.05)
- âœ… Movimento superior > movimento mÃ©dio
- âœ… Alta estabilidade temporal

```python
if face_detected AND 
   motion_intensity < 0.05 AND 
   upper_motion > middle_motion:
    
    # VerificaÃ§Ã£o de estabilidade (Ãºltimos 15 frames)
    if std_deviation(last_15_motions) < 0.02:
        â†’ "Lendo / Estudando"
```

**CaracterÃ­sticas Visuais:**
- Postura estÃ¡tica
- CabeÃ§a ligeiramente inclinada
- Movimento mÃ­nimo dos olhos
- AusÃªncia de gestos

---

### ğŸ’¬ 4. Conversando / Ocioso

**CritÃ©rios de DetecÃ§Ã£o:**
- âœ… Face presente
- âœ… Movimento baixo a moderado (< 0.15)
- âœ… NÃ£o atende critÃ©rios de outras atividades

```python
if face_detected AND motion_intensity < 0.15:
    # PadrÃ£o default para presenÃ§a humana
    â†’ "Conversando / Ocioso"
```

**CaracterÃ­sticas Visuais:**
- Pessoa presente mas sem atividade especÃ­fica
- Movimento natural do corpo
- Pode incluir conversaÃ§Ã£o
- Gestos ocasionais

---

## Features ExtraÃ­das

Para cada frame, o sistema extrai:

```python
features = {
    'num_faces': int,              # Quantidade de rostos
    'num_hands': int,              # Quantidade de mÃ£os detectadas
    'motion_intensity': float,     # Intensidade geral (0.0-1.0)
    'upper_region_motion': float,  # Movimento superior (0.0-1.0)
    'middle_region_motion': float, # Movimento mÃ©dio (0.0-1.0)
    'lower_region_motion': float,  # Movimento inferior (0.0-1.0)
    'hand_near_face': bool,        # MÃ£o prÃ³xima ao rosto?
    'concentrated_motion': bool,   # Movimento localizado?
    'num_bodies': int              # Corpos superiores detectados
}
```

---

## HistÃ³rico Temporal

O sistema mantÃ©m histÃ³ricos para anÃ¡lise temporal:

```python
# Janela temporal: 60 frames (2 segundos a 30 FPS)
activity_history = deque(maxlen=60)

# Janela para movimento: 30 frames (1 segundo)
motion_history = deque(maxlen=30)
```

**Uso do HistÃ³rico:**
- SuavizaÃ§Ã£o de classificaÃ§Ãµes
- DetecÃ§Ã£o de padrÃµes consistentes
- ReduÃ§Ã£o de falsos positivos
- AnÃ¡lise de tendÃªncias

---

## MÃ©tricas de Performance

### Thresholds Calibrados

| ParÃ¢metro | Valor | Justificativa |
|-----------|-------|---------------|
| `motion_threshold` | 0.02 | Distingue movimento mÃ­nimo de ruÃ­do |
| `pc_work_motion` | 0.02-0.15 | Faixa tÃ­pica de trabalho em PC |
| `reading_motion` | < 0.05 | Leitura requer estabilidade |
| `hand_face_distance` | 150px | DistÃ¢ncia tÃ­pica de celular na mÃ£o |
| `skin_color_range` | [0-20, 20-255, 70-255] | HSV calibrado para tons de pele |
| `hand_area_min` | 500pxÂ² | Elimina pequenos artefatos |
| `hand_area_max` | 50000pxÂ² | Evita detecÃ§Ã£o de corpo inteiro |

---

## LimitaÃ§Ãµes e Melhorias Futuras

### LimitaÃ§Ãµes Atuais

1. **IluminaÃ§Ã£o**: SensÃ­vel a mudanÃ§as bruscas de luz
2. **Ã‚ngulo**: Melhor performance com cÃ¢mera frontal
3. **Cor de pele**: Range HSV pode nÃ£o cobrir todas as etnias
4. **ResoluÃ§Ã£o**: Melhor em vÃ­deos HD (720p+)

### Melhorias Propostas

1. **Deep Learning**: Integrar modelos CNN para reconhecimento de pose
2. **Tracking**: Implementar rastreamento de objetos entre frames
3. **CalibraÃ§Ã£o AutomÃ¡tica**: Ajuste dinÃ¢mico de thresholds
4. **Multi-pessoa**: AnÃ¡lise individual em cenas com vÃ¡rias pessoas

---

## Exemplo de Uso AvanÃ§ado

### Ajustando Sensibilidade

```python
# No cÃ³digo video_analysis.py, mÃ©todo _classify_activity

# Para detectar mais facilmente "Trabalhando (PC)"
if middle_motion > 0.015:  # Era 0.02, agora mais sensÃ­vel
    return "Trabalhando (PC)"

# Para ser mais rigoroso com "Usando Celular"
if hand_near_face and upper_motion > 0.05:  # Era 0.03, agora mais rigoroso
    return "Usando Celular"
```

### Adicionando Nova Categoria

```python
def _classify_activity(self, features):
    # Nova categoria: "Fazendo ExercÃ­cio"
    if (features['motion_intensity'] > 0.20 and
        features['num_faces'] > 0 and
        features['upper_region_motion'] > 0.15):
        return "Fazendo ExercÃ­cio"
    
    # Categorias existentes...
```

---

## ValidaÃ§Ã£o e Testes

### Casos de Teste Recomendados

1. **VÃ­deo com pessoa trabalhando em laptop**
   - Esperado: 60-80% "Trabalhando (PC)"

2. **VÃ­deo com pessoa lendo livro**
   - Esperado: 70-90% "Lendo / Estudando"

3. **VÃ­deo com pessoa usando smartphone**
   - Esperado: 50-70% "Usando Celular"

4. **VÃ­deo de conversaÃ§Ã£o**
   - Esperado: 60-80% "Conversando / Ocioso"

### MÃ©tricas de AvaliaÃ§Ã£o

- **AcurÃ¡cia**: Taxa de acertos na classificaÃ§Ã£o
- **PrecisÃ£o**: Verdadeiros positivos / (VP + Falsos Positivos)
- **Recall**: Verdadeiros positivos / (VP + Falsos Negativos)
- **F1-Score**: MÃ©dia harmÃ´nica de PrecisÃ£o e Recall

---

## ReferÃªncias TÃ©cnicas

- **OpenCV**: Biblioteca de Computer Vision
- **Haar Cascades**: DetecÃ§Ã£o de objetos
- **HSV Color Space**: RepresentaÃ§Ã£o de cores
- **Frame Differencing**: TÃ©cnica de detecÃ§Ã£o de movimento
- **Morphological Operations**: Processamento de imagens binÃ¡rias

---

**Desenvolvido para anÃ¡lise avanÃ§ada de comportamento humano em vÃ­deos**
